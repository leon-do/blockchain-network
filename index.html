<html>
<head>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" type="text/css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <style type="text/css">
        #mynetwork {
            width: 100%;
            height: 100%;
            border: 1px solid lightgray;
        }
    </style>
</head>
<body>

<div> ETH address </div>
<input id='input' placeholder='0x120A270bbC009644e35F0bB6ab13f95b8199c4ad'>
<button onclick="map()">Map</button>

<div id="mynetwork"></div>

<script type="text/javascript">

$( document ).ready(function() {
    map('0x120A270bbC009644e35F0bB6ab13f95b8199c4ad')
})

async function map(address) {

    if (!address) {
        address = $('#input').val()
    }

    const transactionData = await getTransactions(address)
    console.log('transactionData =', transactionData)

    const dataSet = getNodeEdgeData(transactionData)
    const nodeData = dataSet.node
    const edgeData = dataSet.edge

    displayData(nodeData, edgeData)
}

// gets data for var node 
// get data for var edge
// returns {node: node, edge: edge}
// aka black magic
function getNodeEdgeData(data) {
    // stores unique 'from' addresses [{-_-}] ZZZzz zz z...
    const unique = {}

    /* 〜(￣▽￣〜)(〜￣▽￣)〜 */
    const nodeArray = []
    const edgeArray = []

    // ◔_◔ loop ◔_◔
    //const i in data
    for (let i = 0; i < 1000; i++ ) {

        // skip if
        if (data[i].to === '') {
            continue
        }

        // called this because... http://visjs.org/docs/network/.          \ᇂ_ᇂ\
        let id = data[i].to 
        let label = data[i].from
        let from = data[i].from
        let to = data[i].to

        // if id is unique then create a node aka ᶠᶸᶜᵏ♥ᵧₒᵤ 
        if (unique[id] === undefined){

            // add to unique (╯°□°）╯︵ ┻━┻)
            unique[id] = id

            // add a ☆(◒‿◒)☆ new node 
            nodeArray.push({
                id: id, 
                label: '.' 
            })

            // add a connection (ㄒoㄒ)
            edgeArray.push({
                from: from, 
                to: to,
            })

        }

    }

    return {node: nodeArray, edge: edgeArray}
}

// https://etherscan.io/apis#accounts
function getTransactions (contractAddress) {
    return new Promise(resolve => {
         /*
         http://api.etherscan.io/api?module=account&action=txlist&address=0x6B9b8Ae3eCF242a214524dBAD07857Da47Fa40b1&startblock=0&endblock=99999999&sort=des
         */
        const uri = `https://api.etherscan.io/api?module=account&action=txlist&address=${contractAddress}&sort=des`
        console.log('uri = ', uri)
        $.get(uri, function(response){
            console.log('response = ', response)
            resolve(response.result)
        })       
    })
}



/*
http://visjs.org/index.html#modules
*/
function displayData(nodeData, edgeData) {

    // create an array with nodes
    var nodes = new vis.DataSet(nodeData);
    console.log('nodeData =',nodeData)

    // create an array with edges
    var edges = new vis.DataSet(edgeData);
    console.log('edgeData =',edgeData)

    // create a network
    var container = document.getElementById('mynetwork');

    // provide the data in the vis format
    var data = {
        nodes: nodes,
        edges: edges
    };
    var options = {

    };

    // initialize your network!
    var network = new vis.Network(container, data, options);
}



</script>
</body>
</html>